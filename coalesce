DROP TABLE DIM_MATERIAL;
CREATE COLUMN TABLE DIM_MATERIAL
(
    PROD_ID CHAR(1),
    DATE_FROM DATE,
    DATE_TO DATE,
    MATERIAL NVARCHAR(20),
    PRIMARY KEY (PROD_ID, DATE_FROM)
);
DROP TABLE DIM_SIZE;
CREATE COLUMN TABLE DIM_SIZE
(
    PROD_ID CHAR(1),
    DATE_FROM DATE,
    DATE_TO DATE,
    SIZE DECIMAL(12,2),
    PRIMARY KEY (PROD_ID, DATE_FROM)
);
INSERT INTO DIM_MATERIAL VALUES ('A', '2014-01-01', '2014-01-08', 'Steel');
INSERT INTO DIM_MATERIAL VALUES ('A', '2014-01-14', '2014-01-24', 'Aluminum');
INSERT INTO DIM_MATERIAL VALUES ('A', '2014-01-25', '2014-01-31', 'Carbon Fiber');
INSERT INTO DIM_SIZE VALUES ('A', '2014-01-11', '2014-01-15', 10);
INSERT INTO DIM_SIZE VALUES ('A', '2014-01-16', '2014-01-19', 12);
DROP PROCEDURE CONSOLIDATE_SCD;
CREATE PROCEDURE CONSOLIDATE_SCD AS
BEGIN
    -- expand DIM_MATERIAL to day-level granularity
     dim_MATERIAL =
          SELECT PROD_ID, DATE_SQL, MATERIAL
          FROM _SYS_BI.M_TIME_DIMENSION TDIM
          INNER JOIN DIM_MATERIAL DIMC ON
               TDIM.DATE_SQL BETWEEN DIMC.DATE_FROM AND DIMC.DATE_TO;
     -- expand DIM_SIZE to day-level granularity
     dim_SIZE =
          SELECT PROD_ID, DATE_SQL, SIZE
          FROM _SYS_BI.M_TIME_DIMENSION TDIM
          INNER JOIN DIM_SIZE DIMW ON
               TDIM.DATE_SQL BETWEEN DIMW.DATE_FROM AND DIMW.DATE_TO;
     -- 1) join on natural key fields + DATE_SQL
     -- 2) retrieve non-null values of key fields and DATE_SQL
     all_dims =
          SELECT
               COALESCE(MATERIAL.PROD_ID, SIZE.PROD_ID) AS PROD_ID,
               COALESCE(MATERIAL.DATE_SQL, SIZE.DATE_SQL) AS DATE_SQL,
               MATERIAL,
               SIZE
          FROM :dim_MATERIAL MATERIAL
          FULL OUTER JOIN :dim_SIZE SIZE ON
               MATERIAL.PROD_ID = SIZE.PROD_ID AND
               MATERIAL.DATE_SQL = SIZE.DATE_SQL;
     -- re-calculate validity dates
     result =
          SELECT
               MIN(DATE_SQL) AS VALID_FROM,
               MAX(DATE_SQL) AS VALID_TO,
               MATERIAL,
               SIZE
          FROM
               :all_dims
          GROUP BY
               MATERIAL,
               SIZE;
    SELECT *
    FROM :result
    ORDER BY VALID_FROM;
END;
CALL CONSOLIDATE_SCD;